<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - Getränkekarte</title>
    <link rel="icon" type="image/png" href="images/schlegl-app-icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <style>
        .schedule-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .schedule-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .schedule-frame.active {
            opacity: 1;
        }

        .schedule-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

    </style>
</head>
<body>
    <div class="schedule-container">
        <!-- Iframe-Container für alle Karten (Lazy Loading) -->
        <div class="schedule-frame" id="hauptthekeFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="theke-hintenFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="theke-hinten-bilderFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="jugendlicheFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="speisekarteFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="bilderFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="screensaverFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="cycleFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="cycle-jugendFrame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="overview-1Frame">
            <iframe></iframe>
        </div>
        <div class="schedule-frame" id="overview-2Frame">
            <iframe></iframe>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let currentCard = '';
        let scheduleConfig = { defaultCard: 'cycle', rules: [] };
        let checkInterval = null;
        let lastConfigUpdate = 0;
        let loadedFrames = new Set();
        let frameUnloadTimeout = null;
        const socket = io();
        
        // Lade Schedule-Konfiguration
        async function loadScheduleConfig() {
            try {
                const response = await fetch('/api/schedule-config');
                scheduleConfig = await response.json();
                lastConfigUpdate = Date.now();
                console.log('Schedule-Konfiguration geladen:', scheduleConfig);
                updateDisplay();
            } catch (error) {
                console.error('Fehler beim Laden der Schedule-Konfiguration:', error);
                // Fallback auf Default
                scheduleConfig = { defaultCard: 'cycle', rules: [] };
                updateDisplay();
            }
        }
        
        // Client-seitige Berechnung der aktuellen Karte
        function calculateCurrentCard() {
            const now = new Date();
            const berlinTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Berlin' }));
            
            const currentDay = berlinTime.getDay(); // 0 = Sonntag, 1 = Montag, etc.
            const currentTime = berlinTime.toTimeString().slice(0, 5); // HH:MM Format
            const currentDate = berlinTime.toISOString().split('T')[0]; // YYYY-MM-DD Format
            
            // Sortiere Regeln nach Priorität: Spezifische Daten > Wöchentliche Regeln
            const sortedRules = [...(scheduleConfig.rules || [])].sort((a, b) => {
                if (a.type === 'date' && b.type === 'weekly') return -1;
                if (a.type === 'weekly' && b.type === 'date') return 1;
                return 0;
            });
            
            // Prüfe jede Regel
            for (const rule of sortedRules) {
                if (rule.type === 'weekly') {
                    // Wöchentliche Regel
                    if (rule.days && rule.days.includes(currentDay)) {
                        if (isTimeInRange(currentTime, rule.startTime, rule.endTime)) {
                            return rule.card;
                        }
                    }
                } else if (rule.type === 'date') {
                    // Spezifische Datumsregel
                    if (isDateInRange(currentDate, rule.startDate, rule.endDate)) {
                        if (isTimeInRange(currentTime, rule.startTime, rule.endTime)) {
                            return rule.card;
                        }
                    }
                }
            }
            
            // Fallback auf Default-Karte
            return scheduleConfig.defaultCard || 'cycle';
        }
        
        // Hilfsfunktionen für Zeit- und Datumsberechnung
        function isTimeInRange(currentTime, startTime, endTime) {
            const current = timeToMinutes(currentTime);
            const start = timeToMinutes(startTime);
            const end = timeToMinutes(endTime);
            
            if (start <= end) {
                // Normale Zeit (z.B. 09:00 - 17:00)
                return current >= start && current <= end;
            } else {
                // Über Mitternacht (z.B. 22:00 - 06:00)
                return current >= start || current <= end;
            }
        }
        
        function isDateInRange(currentDate, startDate, endDate) {
            if (!endDate) {
                // Nur Start-Datum (einzelner Tag)
                return currentDate === startDate;
            }
            return currentDate >= startDate && currentDate <= endDate;
        }
        
        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // Lazy Loading: Lade iFrame nur wenn es benötigt wird
        function loadFrame(cardName) {
            const frameId = `${cardName}Frame`;
            const frame = document.getElementById(frameId);
            
            if (!frame) {
                console.warn(`Frame für Karte '${cardName}' nicht gefunden`);
                return null;
            }
            
            // Prüfe ob Frame bereits geladen ist
            if (loadedFrames.has(cardName)) {
                return frame;
            }
            
            // Lade iFrame nur wenn es noch nicht geladen wurde
            const iframe = frame.querySelector('iframe');
            if (iframe && !iframe.src) {
                iframe.src = `/${cardName}`;
                console.log(`Lazy Loading: ${cardName} iFrame geladen`);
            }
            
            loadedFrames.add(cardName);
            return frame;
        }
        
        // Memory Management: Entferne inaktive iFrames nach einer Weile
        function scheduleFrameUnload() {
            // Stoppe vorherigen Timeout
            if (frameUnloadTimeout) {
                clearTimeout(frameUnloadTimeout);
            }
            
            // Plane Entfernung inaktiver Frames nach 5 Minuten
            frameUnloadTimeout = setTimeout(() => {
                unloadInactiveFrames();
            }, 5 * 60 * 1000); // 5 Minuten
        }
        
        function unloadInactiveFrames() {
            const allFrames = document.querySelectorAll('.schedule-frame');
            const currentFrame = document.getElementById(`${currentCard}Frame`);
            
            allFrames.forEach(frame => {
                if (frame !== currentFrame && !frame.classList.contains('active')) {
                    const iframe = frame.querySelector('iframe');
                    if (iframe && iframe.src) {
                        // Entferne src um iFrame zu entladen
                        iframe.src = '';
                        const cardName = frame.id.replace('Frame', '');
                        loadedFrames.delete(cardName);
                        console.log(`Memory Management: ${cardName} iFrame entladen`);
                    }
                }
            });
        }
        
        // Aktualisiere die Anzeige mit Client-seitiger Berechnung
        function updateDisplay() {
            const newCard = calculateCurrentCard();
            
            if (newCard === currentCard) return;
            
            console.log(`Schedule-Wechsel: ${currentCard} -> ${newCard}`);
            
            // Deaktiviere aktuellen Frame
            if (currentCard) {
                const currentFrame = document.getElementById(`${currentCard}Frame`);
                if (currentFrame) {
                    currentFrame.classList.remove('active');
                }
            }
            
            currentCard = newCard;
            
            // Lade und aktiviere neuen Frame (Lazy Loading)
            if (currentCard) {
                const newFrame = loadFrame(currentCard);
                if (newFrame) {
                    newFrame.classList.add('active');
                    // Plane Entfernung inaktiver Frames
                    scheduleFrameUnload();
                } else {
                    console.warn(`Frame für Karte '${currentCard}' konnte nicht geladen werden`);
                    // Fallback auf cycle
                    currentCard = 'cycle';
                    const fallbackFrame = loadFrame('cycle');
                    if (fallbackFrame) {
                        fallbackFrame.classList.add('active');
                    }
                }
            }
        }
        
        // Starte periodische Überprüfung mit optimiertem Intervall
        function startScheduleCheck() {
            // Sofortige erste Prüfung
            updateDisplay();
            
            // Dann alle 30 Sekunden (optimiert für bessere Responsivität)
            checkInterval = setInterval(() => {
                updateDisplay();
                // Gelegentliche Server-Synchronisation (alle 5 Minuten)
                if (Date.now() - lastConfigUpdate > 5 * 60 * 1000) {
                    syncWithServer();
                }
            }, 30000);
            console.log('Schedule-Überprüfung gestartet (30s Intervall)');
        }
        
        // Stoppe periodische Überprüfung
        function stopScheduleCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
                console.log('Schedule-Überprüfung gestoppt');
            }
            
            // Stoppe auch Frame-Unload Timeout
            if (frameUnloadTimeout) {
                clearTimeout(frameUnloadTimeout);
                frameUnloadTimeout = null;
            }
        }
        
        // Gelegentliche Server-Synchronisation
        async function syncWithServer() {
            try {
                const response = await fetch('/api/schedule-config');
                const serverConfig = await response.json();
                
                // Prüfe ob sich die Konfiguration geändert hat
                if (JSON.stringify(serverConfig) !== JSON.stringify(scheduleConfig)) {
                    console.log('Server-Konfiguration geändert, aktualisiere...');
                    scheduleConfig = serverConfig;
                    lastConfigUpdate = Date.now();
                    updateDisplay();
                }
            } catch (error) {
                console.warn('Server-Synchronisation fehlgeschlagen:', error);
            }
        }
        
        // Socket.IO Event-Listener
        socket.on('scheduleConfigChanged', (data) => {
            console.log('Schedule-Konfiguration geändert:', data);
            scheduleConfig = data;
            lastConfigUpdate = Date.now();
            updateDisplay();
        });
        
        socket.on('forceScheduleReload', () => {
            console.log('Forced Reload für Schedule');
            // Entlade alle Frames vor Reload
            unloadInactiveFrames();
            location.reload();
        });
        
        // Cleanup beim Verlassen der Seite
        window.addEventListener('beforeunload', () => {
            stopScheduleCheck();
            // Entlade alle Frames beim Verlassen
            unloadInactiveFrames();
        });
        
        // Initialisiere mit verbesserter Fehlerbehandlung
        async function initializeSchedule() {
            try {
                await loadScheduleConfig();
                startScheduleCheck();
                console.log('Schedule erfolgreich initialisiert');
            } catch (error) {
                console.error('Fehler bei der Schedule-Initialisierung:', error);
                // Fallback: Starte trotzdem mit Default-Konfiguration
                scheduleConfig = { defaultCard: 'cycle', rules: [] };
                startScheduleCheck();
            }
        }
        
        // Starte Initialisierung
        initializeSchedule();
    </script>
</body>
</html>
